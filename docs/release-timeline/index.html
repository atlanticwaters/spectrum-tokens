<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectrum Tokens Release Timeline</title>
    <style>
        body {
            font-family: "Adobe Clean", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #1473e6;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #1473e6;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .timeline-svg {
            width: 100%;
            height: 400px;
        }
        
        .monthly-chart {
            height: 300px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .feature-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            border-left: 4px solid #1473e6;
        }
        
        .feature-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .feature-count {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Spectrum Tokens Release Timeline</h1>
        <p>Interactive visualization of design token release history and change frequency</p>
    </div>

    <div class="stats-grid" id="stats-grid">
        <!-- Stats will be populated by JavaScript -->
    </div>

    <div class="chart-container">
        <h2 class="chart-title">Release Timeline</h2>
        <div class="legend" id="timeline-legend">
            <!-- Legend will be populated by JavaScript -->
        </div>
        <svg class="timeline-svg" id="timeline-chart"></svg>
    </div>

    <div class="chart-container">
        <h2 class="chart-title">Monthly Release Activity</h2>
        <svg class="timeline-svg monthly-chart" id="monthly-chart"></svg>
    </div>

    <div class="chart-container">
        <h2 class="chart-title">Snapshot Feature Development</h2>
        <p style="color: #666; margin-bottom: 20px;">Experimental development areas with their release counts</p>
        <div class="features-grid" id="features-grid">
            <!-- Features will be populated by JavaScript -->
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Color scheme for different release types
        const colors = {
            legacy: '#8A8A8A',    // Gray
            stable: '#2ECC40',    // Green  
            beta: '#FF851B',      // Orange
            snapshot: '#B10DC9'   // Purple
        };

        const typeLabels = {
            legacy: 'Legacy (v*)',
            stable: 'Stable',
            beta: 'Beta',
            snapshot: 'Snapshot'
        };

        let data = null;
        let tooltip = d3.select("#tooltip");

        // Load and process data
        d3.json("data/releases.json").then(function(releaseData) {
            data = releaseData;
            
            // Create visualizations
            createStatsCards();
            createTimelineChart();
            createMonthlyChart();
            createFeaturesGrid();
        }).catch(function(error) {
            console.error("Error loading data:", error);
        });

        function createStatsCards() {
            const statsContainer = d3.select("#stats-grid");
            
            const stats = [
                { label: "Total Releases", value: data.stats.total },
                { label: "Legacy Releases", value: data.stats.byType.legacy },
                { label: "Stable Releases", value: data.stats.byType.stable },
                { label: "Beta Releases", value: data.stats.byType.beta },
                { label: "Snapshot Releases", value: data.stats.byType.snapshot },
                { label: "Development Features", value: data.stats.snapshotFeatures },
                { label: "Years of History", value: Math.round((new Date(data.stats.dateRange.latest) - new Date(data.stats.dateRange.earliest)) / (365.25 * 24 * 60 * 60 * 1000)) }
            ];
            
            const cards = statsContainer.selectAll(".stat-card")
                .data(stats)
                .enter()
                .append("div")
                .attr("class", "stat-card");
                
            cards.append("div")
                .attr("class", "stat-number")
                .text(d => d.value.toLocaleString());
                
            cards.append("div")
                .attr("class", "stat-label")
                .text(d => d.label);
        }

        function createTimelineChart() {
            const svg = d3.select("#timeline-chart");
            const margin = { top: 20, right: 20, bottom: 40, left: 60 };
            const width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            // Create legend
            const legend = d3.select("#timeline-legend");
            Object.keys(colors).forEach(type => {
                const item = legend.append("div").attr("class", "legend-item");
                item.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", colors[type]);
                item.append("span")
                    .text(`${typeLabels[type]} (${data.stats.byType[type]})`);
            });

            // Parse dates and sort timeline
            const parseDate = d3.timeParse("%Y-%m-%d");
            const timeline = data.timeline.map(d => ({
                ...d,
                date: parseDate(d.date)
            })).sort((a, b) => a.date - b.date);

            // Create scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(timeline, d => d.date))
                .range([0, width]);

            const yScale = d3.scaleBand()
                .domain(Object.keys(colors))
                .range([height, 0])
                .padding(0.1);

            // Create main group
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Add axes
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%Y")));

            g.append("g")
                .call(d3.axisLeft(yScale).tickFormat(d => typeLabels[d]));

            // Add dots for each release with variable sizing based on change scope
            g.selectAll(".release-dot")
                .data(timeline)
                .enter()
                .append("circle")
                .attr("class", "release-dot")
                .attr("cx", d => xScale(d.date))
                .attr("cy", d => yScale(d.type) + yScale.bandwidth() / 2)
                .attr("r", d => {
                    // Use change scope score for dot sizing (2-8px range)
                    if (d.changeScope && d.changeScope.score) {
                        return 1 + d.changeScope.score;
                    }
                    return 3; // Default size
                })
                .attr("fill", d => colors[d.type])
                .attr("opacity", 0.7)
                .attr("stroke", d => {
                    // Add stroke for releases with scope data
                    return d.changeScope ? "#333" : "none";
                })
                .attr("stroke-width", d => d.changeScope ? 0.5 : 0)
                .on("mouseover", function(event, d) {
                    const scopeInfo = d.changeScope ? 
                        `<br/>Changes: ${d.changeScope.total} (${d.changeScope.added}A/${d.changeScope.updated}U/${d.changeScope.deleted}D)` : 
                        '';
                    
                    tooltip.style("opacity", 1)
                        .html(`
                            <strong>${d.tag}</strong><br/>
                            Type: ${typeLabels[d.type]}<br/>
                            Date: ${d.date.toLocaleDateString()}<br/>
                            ${d.feature ? `Feature: ${d.feature}<br/>` : ''}${scopeInfo}
                        `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });
        }

        function createMonthlyChart() {
            const svg = d3.select("#monthly-chart");
            const margin = { top: 20, right: 20, bottom: 40, left: 60 };
            const width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            // Parse dates and group by month
            const parseDate = d3.timeParse("%Y-%m-%d");
            const timeline = data.timeline.map(d => ({
                ...d,
                date: parseDate(d.date)
            }));

            // Group by month and count releases
            const monthlyData = d3.rollup(
                timeline,
                v => v.length,
                d => d3.timeMonth(d.date)
            );

            const monthlyArray = Array.from(monthlyData, ([month, count]) => ({
                month,
                count
            })).sort((a, b) => a.month - b.month);

            // Create scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(monthlyArray, d => d.month))
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(monthlyArray, d => d.count)])
                .range([height, 0]);

            // Create main group
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Add axes
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%Y")));

            g.append("g")
                .call(d3.axisLeft(yScale));

            // Add axis labels
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "#666")
                .text("Releases per Month");

            // Create line
            const line = d3.line()
                .x(d => xScale(d.month))
                .y(d => yScale(d.count))
                .curve(d3.curveMonotoneX);

            // Add the line
            g.append("path")
                .datum(monthlyArray)
                .attr("fill", "none")
                .attr("stroke", "#1473e6")
                .attr("stroke-width", 2)
                .attr("d", line);

            // Add dots
            g.selectAll(".month-dot")
                .data(monthlyArray)
                .enter()
                .append("circle")
                .attr("class", "month-dot")
                .attr("cx", d => xScale(d.month))
                .attr("cy", d => yScale(d.count))
                .attr("r", 4)
                .attr("fill", "#1473e6")
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`
                            <strong>${d3.timeFormat("%B %Y")(d.month)}</strong><br/>
                            Releases: ${d.count}
                        `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });
        }

        function createFeaturesGrid() {
            const container = d3.select("#features-grid");
            
            data.snapshotFeatures.forEach(feature => {
                const card = container.append("div")
                    .attr("class", "feature-card");
                    
                card.append("div")
                    .attr("class", "feature-name")
                    .text(feature.feature);
                    
                card.append("div")
                    .attr("class", "feature-count")
                    .text(`${feature.count} release${feature.count > 1 ? 's' : ''}`);
            });
        }
    </script>
</body>
</html>
